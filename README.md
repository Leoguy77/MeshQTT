# MeshQTT

MeshQTT is a MQTT broker specifically designed for meshtastic networks. It handels encrypted Meshtastic packets and allows for more more specific control compared to normal MQTT brokers like Mosquitto.
It supports advanced filtering and processing of messages, making it ideal for applications that require fine-grained control over the data being transmitted in a meshtastic network.

# Features

- Handles encrypted Meshtastic packets
- Allows for more specific control compared to normal MQTT brokers
- Supports advanced filtering and processing of messages
- **TLS/SSL Support** - Secure MQTT connections with automatic certificate generation

## TLS Configuration

MeshQTT supports TLS/SSL encryption for secure MQTT connections. The TLS configuration is handled through the `config.json` file.

### Configuration Options

```json
{
  "TlsEnabled": true,
  "TlsPort": 8883,
  "CertificatePath": "certs/server.crt",
  "PrivateKeyPath": "certs/server.key",
  "CertificatePassword": ""
}
```

- `TlsEnabled`: Set to `true` to enable TLS support
- `TlsPort`: Port for TLS connections (default: 8883)
- `CertificatePath`: Path to your certificate file (.crt or .pem)
- `PrivateKeyPath`: Path to your private key file (.key or .pem)
- `CertificatePassword`: Password for the certificate (if required)

### Certificate Support

MeshQTT supports the following certificate formats:

- **PEM files** (.pem) - Both certificate and key in PEM format
- **CRT files** (.crt) - Certificate with separate .key file
- **PFX/P12 files** (.pfx, .p12) - PKCS#12 format with embedded private key

### Automatic Self-Signed Certificates

If no valid certificate files are found at the specified paths, MeshQTT will automatically generate a self-signed certificate for development and testing purposes. The generated certificate will be saved to the `certs/` directory:

- `certs/server.crt` - The certificate file
- `certs/server.key` - The private key file

### Production Deployment

For production environments, it's recommended to use certificates from a trusted Certificate Authority (CA) or use Let's Encrypt for automatic certificate management.

#### Using Let's Encrypt certificates:

```json
{
  "TlsEnabled": true,
  "TlsPort": 8883,
  "CertificatePath": "/etc/letsencrypt/live/yourdomain.com/fullchain.pem",
  "PrivateKeyPath": "/etc/letsencrypt/live/yourdomain.com/privkey.pem"
}
```

#### Using custom certificates:

```json
{
  "TlsEnabled": true,
  "TlsPort": 8883,
  "CertificatePath": "/path/to/your/certificate.crt",
  "PrivateKeyPath": "/path/to/your/private.key",
  "CertificatePassword": "your-cert-password"
}
```

### Testing TLS Connection

To test the TLS connection, you can use mosquitto client tools:

```bash
# Test with self-signed certificate (using server certificate as CA)
mosquitto_pub -h localhost -p 8883 --cafile certs/server.crt -u username -P password -i "test-client" -t test -m "hello TLS"

# Test with insecure flag (skip certificate validation - only for testing)
mosquitto_pub -h localhost -p 8883 --insecure -u username -P password -i "test-client" -t test -m "hello TLS"
```

**Note**: When using self-signed certificates, clients need to either:

1. Use the `--cafile` option pointing to the server certificate
2. Use the `--insecure` flag to skip certificate validation (not recommended for production)
3. Import the certificate into the system's certificate store

## Docker Deployment with TLS

### Docker Compose Setup

The provided `compose.yaml` is already configured for TLS support:

```yaml
services:
  meshqtt:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "1883:1883" # MQTT port
      - "8883:8883" # MQTT TLS port
      - "9000:9000" # Metrics port
    volumes:
      - ./config:/App/config:rw
      - ./logs:/App/logs:rw
      - ./certs:/App/certs:rw # TLS certificates directory
```

### Using TLS with Docker

1. **Enable TLS in config.json**:

   ```json
   {
     "TlsEnabled": true,
     "TlsPort": 8883,
     "CertificatePath": "certs/server.crt",
     "PrivateKeyPath": "certs/server.key"
   }
   ```

2. **Start with Docker Compose**:

   ```bash
   docker-compose up -d
   ```

3. **Using custom certificates**: Place your certificate files in the `./certs` directory:

   ```
   certs/
   ├── server.crt    # Your certificate
   └── server.key    # Your private key
   ```

4. **Test TLS connection**:

   ```bash
   # If using self-signed certificates generated by the app
   mosquitto_pub -h localhost -p 8883 --cafile certs/server.crt -u username -P password -i "test-client" -t test -m "hello docker TLS"

   # Or skip certificate validation for testing
   mosquitto_pub -h localhost -p 8883 --insecure -u username -P password -i "test-client" -t test -m "hello docker TLS"
   ```

### Certificate Persistence

When using Docker, certificates generated by the application will be stored in the `./certs` directory on the host, ensuring they persist across container restarts.
